<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Map with Drive Image EXIF</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- EXIF reader -->
<script src="https://unpkg.com/exifr/dist/lite.umd.js"></script>

<style>
  #map { height: 70vh; }
  #controls { width: 90%; margin: 10px auto; text-align: center; }
  #timestamp { font-size: 1.4em; font-weight: bold; margin-top: 10px; }
  .date-part { color: #444; font-size: 1.2em; }
  .time-part { color: #000; font-size: 1.6em; }
</style>
</head>
<body>

<div id="map"></div>

<div id="controls">
  <label>Start Date:</label>
  <input type="date" id="startDate">
  <label>End Date:</label>
  <input type="date" id="endDate">
  <br><br>

  <label>Start Hour:</label>
  <input type="number" id="startHour" min="0" max="23" value="0">
  <label>End Hour:</label>
  <input type="number" id="endHour" min="0" max="23" value="23">
  <br><br>

  <input id="timeSlider" type="range" min="0" max="0" value="0" style="width:100%;">
  <div id="timestamp"></div>
</div>

<script>
/* ---------- CONFIG ---------- */
const BOUNDS = [25, 90, 46, 145];
const LOCATION_LOG_URL = "https://raw.githubusercontent.com/Wiznerd1/Japan2025.github.io/main/location_log.txt";
const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyUzgCzSz7j0uBhJnUbZnc-zgkRfrCbL57u5S_tAlm9-j8DjvA7yF_3qn3-ie4AETuU/exec";

/* ---------- MAP ---------- */
const map = L.map('map').setView([35, 135], 6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

/* ---------- DATA ---------- */
let trackPoints = [];
let imagePoints = [];
let allPoints = [];
let filteredPoints = [];

const slider = document.getElementById("timeSlider");
const tsLabel = document.getElementById("timestamp");
const startDateInput = document.getElementById("startDate");
const endDateInput = document.getElementById("endDate");
const startHourInput = document.getElementById("startHour");
const endHourInput = document.getElementById("endHour");

let movingMarker = null;

/* -----------------------------------------------------
   1. Load Track Log
----------------------------------------------------- */
async function loadTrackPoints() {
  const text = await fetch(LOCATION_LOG_URL).then(r => r.text());
  const lines = text.split("\n");

  for (let line of lines) {
    line = line.trim();
    if (!line) continue;

    const [timeStr, coordsStr] = line.split(": ");
    if (!coordsStr) continue;

    const [lat, lon] = coordsStr.split(", ").map(Number);

    trackPoints.push({
      lat,
      lon,
      time: new Date(timeStr),
      type: "track",
      url: null
    });
  }
}

/* -----------------------------------------------------
   2. Load image URLs + extract EXIF
----------------------------------------------------- */
async function loadImageExif() {
  const urls = await fetch(APPS_SCRIPT_URL).then(r => r.json());

  for (let url of urls) {
    try {
      // Fetch EXIF from the image
      const exif = await exifr.parse(url, { gps: true });

      if (!exif || !exif.latitude || !exif.longitude) continue;

      imagePoints.push({
        lat: exif.latitude,
        lon: exif.longitude,
        time: exif.DateTimeOriginal ? new Date(exif.DateTimeOriginal) : new Date(),
        type: "image",
        url: url
      });

    } catch (e) {
      console.warn("EXIF error for:", url, e);
    }
  }
}

/* -----------------------------------------------------
   Merge + sort
----------------------------------------------------- */
function mergePoints() {
  allPoints = [...trackPoints, ...imagePoints];
  allPoints.sort((a, b) => a.time - b.time);
}

/* -----------------------------------------------------
   Filtering
----------------------------------------------------- */
function applyFilters() {
  const startDate = startDateInput.value ? new Date(startDateInput.value + "T00:00") : null;
  const endDate = endDateInput.value ? new Date(endDateInput.value + "T23:59") : null;
  const startHour = parseInt(startHourInput.value);
  const endHour = parseInt(endHourInput.value);

  filteredPoints = allPoints.filter(p => {
    const t = p.time;
    const hour = t.getHours();

    if (startDate && t < startDate) return false;
    if (endDate && t > endDate) return false;
    if (hour < startHour || hour > endHour) return false;
    if (p.lat < BOUNDS[0] || p.lat > BOUNDS[1]) return false;
    if (p.lon < BOUNDS[2] || p.lon > BOUNDS[3]) return false;

    return true;
  });

  redraw();
}

/* -----------------------------------------------------
   Redraw map + marker
----------------------------------------------------- */
function redraw() {
  if (movingMarker) {
    map.removeLayer(movingMarker);
    movingMarker = null;
  }

  if (filteredPoints.length === 0) {
    tsLabel.textContent = "No data";
    slider.max = 0;
    return;
  }

  slider.min = 0;
  slider.max = filteredPoints.length - 1;
  slider.value = 0;

  updateMarker(0);
}

/* -----------------------------------------------------
   Update marker
----------------------------------------------------- */
function updateMarker(i) {
  const p = filteredPoints[i];
  if (!p) return;

  if (!movingMarker) {
    movingMarker = L.marker([p.lat, p.lon]).addTo(map);
  } else {
    movingMarker.setLatLng([p.lat, p.lon]);
  }

  if (p.type === "image")
    movingMarker.bindPopup(`<img src="${p.url}" width="200">`).openPopup();
  else
    movingMarker.closePopup();

  const dateStr = p.time.toLocaleDateString();
  const timeStr = p.time.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit", second: "2-digit" });

  tsLabel.innerHTML = `
    <div class="date-part">${dateStr}</div>
    <div class="time-part">${timeStr}</div>
  `;
}

/* -----------------------------------------------------
   Events
----------------------------------------------------- */
slider.addEventListener("input", () => updateMarker(parseInt(slider.value)));
startDateInput.addEventListener("change", applyFilters);
endDateInput.addEventListener("change", applyFilters);
startHourInput.addEventListener("change", applyFilters);
endHourInput.addEventListener("change", applyFilters);

/* -----------------------------------------------------
   Main load
----------------------------------------------------- */
(async () => {
  await loadTrackPoints();
  await loadImageExif();
  mergePoints();
  applyFilters();
})();
</script>

</body>
</html>