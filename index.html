<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Time Slider Map with Track Line</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
  #map { height: 75vh; }
  #controls {
    width: 80%;
    margin: 10px auto;
    text-align: center;
  }
  #controls select {
    margin: 5px;
    padding: 5px;
  }
</style>

</head>
<body>

<div id="map"></div>

<div id="controls">
  <label>Date: </label>
  <select id="daySelect"></select>

  <label>Hour: </label>
  <select id="hourSelect">
    <option value="">Any</option>
  </select>

  <br><br>

  <input id="timeSlider" type="range" min="0" max="0" value="0" style="width:100%;">
  <div id="timestamp" style="text-align:center; margin-top:5px;"></div>
</div>

<script>
const TXT_URL = "https://raw.githubusercontent.com/Wiznerd1/Japan2025.github.io/main/location_log.txt";

const map = L.map('map').setView([1.298, 103.776], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

// Data arrays
let timestamps = [];
let coords = [];

let filteredTimestamps = [];
let filteredCoords = [];

let slider = document.getElementById("timeSlider");
let tsLabel = document.getElementById("timestamp");
let daySelect = document.getElementById("daySelect");
let hourSelect = document.getElementById("hourSelect");

let marker = null;
let polyline = null;

// Generate hour options (00â€“23)
for (let h = 0; h < 24; h++) {
  let hh = h.toString().padStart(2, '0');
  hourSelect.innerHTML += `<option value="${hh}">${hh}:00</option>`;
}

fetch(TXT_URL)
  .then(res => res.text())
  .then(text => {
    const lines = text.split("\n");
    let uniqueDates = new Set();

    lines.forEach(line => {
      line = line.trim();
      if (!line) return;
      const parts = line.split(": ");
      if (parts.length !== 2) return;

      const time = new Date(parts[0]);
      const [latStr, lonStr] = parts[1].split(", ");
      const lat = parseFloat(latStr);
      const lon = parseFloat(lonStr);

      coords.push([lat, lon]);
      timestamps.push(time);

      uniqueDates.add(parts[0].split(" ")[0]); // YYYY-MM-DD
    });

    // populate day dropdown
    uniqueDates = Array.from(uniqueDates).sort();
    daySelect.innerHTML = `<option value="">Any</option>`;
    uniqueDates.forEach(d => {
      daySelect.innerHTML += `<option value="${d}">${d}</option>`;
    });

    // After load, apply filters (default = all points)
    applyFilters();
  });

function applyFilters() {
  const selectedDay = daySelect.value;   // "" means ANY day
  const selectedHour = hourSelect.value; // "" means ANY hour

  filteredCoords = [];
  filteredTimestamps = [];

  for (let i = 0; i < timestamps.length; i++) {
    const t = timestamps[i];

    const day = t.toISOString().split("T")[0];
    const hour = t.getHours().toString().padStart(2, '0');

    if ((selectedDay === "" || selectedDay === day) &&
        (selectedHour === "" || selectedHour === hour)) {

      filteredCoords.push(coords[i]);
      filteredTimestamps.push(t);
    }
  }

  redrawMap();
}

function redrawMap() {
  // Clear old polyline
  if (polyline) {
    map.removeLayer(polyline);
  }

  // Clear marker
  if (marker) {
    map.removeLayer(marker);
    marker = null;
  }

  if (filteredCoords.length > 0) {
    polyline = L.polyline(filteredCoords, {color: 'blue', weight: 3}).addTo(map);
    map.fitBounds(polyline.getBounds());

    slider.max = filteredCoords.length - 1;
    slider.min = 0;
    slider.value = 0;

    updateMarker(0);
  } else {
    tsLabel.textContent = "No data for this selection";
    slider.max = 0;
    slider.value = 0;
  }
}

function updateMarker(i) {
  if (!filteredCoords[i]) return;

  if (!marker) {
    marker = L.marker(filteredCoords[i]).addTo(map);
  } else {
    marker.setLatLng(filteredCoords[i]);
  }

  tsLabel.textContent = filteredTimestamps[i].toISOString();
}

// slider moves through filtered points only
slider.addEventListener("input", () => {
  updateMarker(parseInt(slider.value));
});

// filters applied on dropdown change
daySelect.addEventListener("change", applyFilters);
hourSelect.addEventListener("change", applyFilters);

</script>

</body>
</html>
